Differences in security between the last and the current governments in Mexico 
========================================================

Last Presidential term (2006-2012) in Mexico was characterized for the violence generated by the war against drug cartels. The current president belongs to a different party and he claimed that his security strategy would be more effective.

In this work, I will try to analize different security indicators for different Presidential terms: 2000-2006, 2006-2012 and 2012-present to see if there are clear differences in security betweeen goverments. 

The webpage [http://crimenmexico.diegovalle.net/en/](http://crimenmexico.diegovalle.net/en/) by [Diego Valle Jones](http://www.diegovalle.net), has some illustrative plots of a subset of crimes-related variables from the Mexican goverment website [Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva). Each Mexican state sends its data in a monthly basis. I will be using the same sourse of data.

In the first section, I decribe what the data consists of. Then I describe some of the problems for downloading the data. The third section shows what I have done so far and the last section describes my plan for the rest of the project.

Description of the data
----------------------------------------------

According to the Federal Attorney General of Mexico, the data is categorized in two types:
- Federal: Those crimes that affect the health, the economy or the security of the country.
  - Against public health: trading, posession, production suplying, traffic, transportation and others.
  - Federal Law of Firearms and Explosives
  - Others: Intelectual property, against natural environment, election related, etcetera.
- Common: Those crimes that affect people directly. 
  - Offenses against property.
  - Sexual crimes
  - Homicides.
  - Injuries.
  - Kidnapping.
  - Common robbery.
  - Cattle raiding.
  - Road robbery.
  - Robbery in banks
  - Others.

Data extraction and associated complications
-------------------------------------------------

The data extraction turned out to be more difficult than I thought. The website of [Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva) displays the following menu (it is in Spanish, but most of the words are cognates):

![02](./webpages_images/02_menu.png)

If the first option is selected, _Herramientas de Análisis_  (Analysis tools), you can create plots for the features and also download the data you are plotting, however, it never works well. The next image is a screenshot the site.

![04](./webpages_images/04_analysis.png)

If you select the option _Exportación de Información_ (Exporting information), you can download the features that you want directly in a `csv` file. My idea was to try to do this automatically from `R`, but it never worked for me, not even manually. The following image shows that menu:
![03](./webpages_images/03_csv.png)

Finally, you can also download the tables in `pdf` files. I found a package in R that could help to obtain the information from tables in `pdf`, however, not all the information is available in `pdf`.

I sent an email message to Diego Valle. He told me that he decided to create those plots precisely because the [goverment webpage](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva) never works. He send me his code in `Python` and he highlighted that he is constantly checking for new information and he extracts very little pieces of information since the wepages crashes otherwise. 

I decided then to use the data directly from [Diego Valle's website](http://crimenmexico.diegovalle.net/en/csv/). If I have time, I will work downloading the data by myself once I finish the other thing I want to do.

The work so far
---------------------------------------------------

I will decribe piece by piece what I have done. I am going to select the crime 'homicides' to illustrate what can be done and what I plan to do. This variable supports what I said at the beginning of the document that violence increased unbelievably during last Presidential term, although we can also observe that 15 years ago the situation was even worse (but none of that was reported on the media).

Loading packages that will be used.
```{r}
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("plyr"))
suppressPackageStartupMessages(library("dplyr"))
suppressPackageStartupMessages(library("lubridate"))
suppressPackageStartupMessages(library("car"))
suppressPackageStartupMessages(library("R.utils")) # To create gz
```

Reading data and creating a unique database
------------------------------------

As I said before, there are two major categories of crimes: Common and Federal. Both have different levels of crime, category, type and subtype. I am going to keep the crime, category and type columns.
I am also going to translate the names to English.


```{r reading, cache = TRUE}
# ### Download directly. It takes a lot of time
# ### Do not run!
# federal.link <- "http://crimenmexico.diegovalle.net/en/csv/fuero-federal-estados.csv.gz"
# common.link <- "http://crimenmexico.diegovalle.net/en/csv/fuero-comun-estados.csv.gz"
# con <- gzcon(url(federal.link))
# txt <- readLines(con)
# dat <- read.csv(textConnection(txt))

### Reading data.
common <- read.csv(gzfile("./data/fuero-comun-estados.csv.gz")) %.% tbl_df() #Common
federal <- read.csv(gzfile("./data/fuero-federal-estados.csv.gz")) %.% tbl_df() #Federal

## Common: crime
sp.names <- common$crime %.% unique() %.% as.character() ## Spanish names
en.names <- c("Property_crimes", ## English names
              "Sexual_crimes",
              "Homicides",
              "Injuries",
              "Other_crimes",
              "Kidnapping",
              "Robbery")
string <- paste0("sp.names[", 1:length(sp.names), "] = ", 
                 "en.names[", 1:length(sp.names), "]", collapse = '; ')
common$crime <- recode(common$crime, string)

## Common: category
sp.names <- common$category %.% unique() %.% as.character() ## Spanish names
en.names <- c("Property_crimes", ## English names
              "Sexual_crimes_(violation)",
              "Homicides",
              "Injuries",
              "Other_crimes",
              "Kidnapping",
              "Common_robbery",
              "Rustling",
              "Highway_robbery",
              "Bank_robbery")
string <- paste0("sp.names[", 1:length(sp.names), "] = ", 
                 "en.names[", 1:length(sp.names), "]", collapse = '; ')
common$category <- recode(common$category, string)

# ## Common: type
# sp.names <- common$type %.% unique() %.% as.character() ## Spanish names
# en.names <- c("Breach_of_trust",
#               "Property_crimes", ## English names
#               "Offense_of_dispossession",
#               "Extortion",
#               "Fraud",
#               "Sexual_crimes_(violation)",
#               "Guilty",
#               "By_negligence",
#               "Guilty",
#               "By_negligence",
#               "Threats",
#               "Staturory_rape",
#               "Other_sexual",
#               "Other_crimes",
#               "Kidnapping",
#               "With_violence",
#               "Without_violence",
#               "Rustling")
# string <- paste0("sp.names[", 1:length(sp.names), "] = ", 
#                  "en.names[", 1:length(sp.names), "]", collapse = '; ')
# common$type <- recode(common$type, string)

## Delete type and sub-type
common <- common[, -(6:7)]

## Federal: crime
sp.names <- federal$crime %.% unique() %.% as.character() ## Spanish names
en.names <- c("Against_health",
              "Other_crimes",
              "Historical_information",
              "Federal_Act_against_organized_crime",
              "General_health_Act",
              "Other_laws")
string <- paste0("sp.names[", 1:length(sp.names), "] = ", 
                 "en.names[", 1:length(sp.names), "]", collapse = '; ')
federal$crime <- recode(federal$crime, string)

## Federal: category
sp.names <- federal$category %.% unique() %.% as.character() ## Spanish names
en.names <- c("Trade",
              "Other",
              "Possession",
              "Production",
              "Supply",
              "Traffic",
              "Transportation",
              "AVGC(1997-2011)",
              "Against_public_official",
              "Against_the_environment", #10
              "Against_body",
              "Electoral",
              "Copyrights",
              "Counterfeiting",
              "Other",
              "Other",
              "Property",
              "Copyrights",
              "Roads",
              "Criminal_association(1997-2011)", #20
              "Vehicle_transportation(1999-2007)",
              "Highway_robbery",
              "Against_health",
              "LFCDO(2001-2011)",
              "Other",
              "Drug_dealing",
              "Other",
              "Federal_tax_code",
              "Industrial_property",
              "Migration", #30
              "Roads",
              "Federal_firearms_and_explosives",
              "Copyrights",
              "Law_of_credit_and_insurance",
              "Other",
              "Other"
              )
string <- paste0("sp.names[", 1:length(sp.names), "] = ", 
                 "en.names[", 1:length(sp.names), "]", collapse = '; ')
federal$category <- recode(federal$category, string)

## Get rid of Law
federal <- federal[, -4]

## Adding common or Federal
common$law <- "common"
federal$law <- "Federal"

## Merging data-sets
data <- rbind(common, federal)

## Deleting variables
rm(common, federal, en.names, sp.names, string)

## 
data <- data %.%
  mutate(date = ymd(paste(year, month, "01", sep = "-"))) %.% # Adding date
  group_by(year, month, crime, category, date)

```

Each presidential term lasts six years. We have to associate with each date the days that the corresponding president has ruled the country and the political party. 

On the other hand, we also have to correct the state codes, since there are states with the wrong labels. Since the Spanish diccionary does not longer consider the _ch_ combination as a letter, so the alphabetical order of the states is slightly different.

```{r fixing, dependson= "reading", cache = TRUE}
### This is the first day of goverment period for recorded data, i.e.,
## We have data starting on 1997. That president started his period on 1994-12-01
day0 <- ymd("1994-12-01")

## Now we add days of goverment and period of goverment.
aux <- function(date)
{
  ## Aux function to determine the period.
  ## Receives date type argument
  val <- ifelse(date < day0 + years(6), 0,
                ifelse(date < day0 + years(2*6), 1,
                       ifelse(date < day0 + years(3*6), 2, 
                              3)
                )
  )
  return(val)
}

data <- group_by(data, law) %.%
  mutate(period.code = aux(date),
         days = as.numeric(date - years(period.code*6) - day0),
         party = c("PAN", "PRI")[((period.code == 0) | (period.code == 3)) + 1]) %.%
  group_by(period.code, days, party, law)

rm(aux)

## We also have to add the right state code, it is wrong beacuse the 'ch'
## is no longer considered "letter" in the Spanish diccitionary
aux <- function(code) 
{
  code[(code == 5) | (code == 6)] <- -1*(code[(code == 5) | (code == 6)] + 2)
  code[(code == 7) | (code == 8)] <- code[(code == 7) | (code == 8)] - 2
  code[code < 0] <- -code[code < 0]
  
  return(code)
}
data <- mutate(data, state_code = aux(state_code))
rm(aux)
```

Finally, we create the tables by states and national summarising different crime types. I am also adding the period (displayed as date). Save tables after that.

```{r tables, dependson= "fixing", cache= FALSE}

## Presitential terms
per <- paste0(1994 + 6*(0:3), "-12-01 to ", 
              2000 + 6*(0:3), "-11-30")

## Add column with Presidential terms
data <- mutate(data, 
               period = paste0(period.code + 1, ". ",
                               per[period.code + 1])) %.%
  group_by(period)
rm(per)

## Creating table by states and adding 
state.wise <- group_by(data, state_code, population) %.%
  summarise(total = sum(count, na.rm = T)) %.%
  mutate(total.rate = 10000*total/population)  

## Same for the whole country
national <- summarise(data, 
                      total = sum(count, na.rm = T),
                      population = sum(unique(population)),
                      total.rate = 10000*total/population)

## Write and compress
write.csv(state.wise, file = "./data/states.csv")
write.csv(national, file = "./data/national.csv")
gzip("./data/national.csv")
gzip("./data/states.csv")
```

The first plot shows the homicides rates (per 10000 person) by days of goverment. I will fix the labels, but 
- period.code = 0 is the period from 1994 to 2000,
- period.code = 1 is the period from 2000 to 2006,
- period.code = 2 is the period from 2006 to 2012 and
- period.code = 3 is the period from 2012 to now.

```{r, dependson= "tables", cache=TRUE, fig.height= 6, fig.width= 9, eval=FALSE}
### Homicides
qplot(days, total.rate, 
      data = filter(national, crime == "HOMICIDIOS"), 
      geom = "line", col = as.factor(period.code)) +
  ggtitle("Homicides rate by days of goverment")
```

Same crime, but now continuously.

```{r, dependson= "tables", cache=TRUE, fig.height= 6, fig.width= 9, eval=FALSE}
### Homicides
qplot(date, total.rate, 
      data = filter(national, crime == "HOMICIDIOS"), 
      geom = "line", col = as.factor(period.code)) +
  ggtitle("Homicides rate by date")
```

The following is the code used to extract the polygons, then I saved the data frame. Do NOT run.

```{r, eval= FALSE}
##### Extracting polygons and saving data.frame, so it will not be run again.
library("maptools")
xx <- readShapeSpatial("../mexico/MEX_adm1.shp")
xxx <- thinnedSpatialPoly(as(xx, "SpatialPolygons"), tolerance = 0.1, minarea = 0.0005, 
                          topologyPreserve = TRUE)
extractPolygons <- function(shapes) {
  require(plyr)
  
  dframe <- ldply(1:length(shapes@polygons), function(i) {
    ob <- shapes@polygons[[i]]@Polygons
    dframe <- ldply(1:length(ob), function(j) {
      x <- ob[[j]]
      co <- x@coords
      data.frame(co, order = 1:nrow(co), group = j)
    })
    dframe$region <- i
    dframe
  })
  # construct a group variable from both group and polygon:
  dframe$group <- interaction(dframe$region, dframe$group)
  
  dframe
}
mex <- extractPolygons(xxx)

state.name <- c("Aguascalientes", "Baja California",
                "Baja California Sur", "Campeche", "Chiapas", #5
                "Chihuahua", "Coahuila", "Colima", 
                "Distrito Federal", "Durango", #10
                "Guanajuato", "Guerrero", "Hidalgo",
                "Jalisco", "Estado de México", #15
                "Michoacán", "Morelos", "Nayarit",
                "Nuevo León", "Oaxaca", #20
                "Puebla", "Querétaro", "Quintana Roo",
                "San Luis Potosí", "Sinaloa", #25
                "Sonora", "Tabasco", "Tamaulipas",
                "Tlaxcala", "Veracruz",
                "Yucatán", "Zacatecas"
                )

mex <- mutate(mex, state.name = state.name[region])
write.csv(mex, "./mexico/polygons.csv")
```

Now we display two maps to make a comparison between two periods of time for the same crime.

```{r maps, dependson= "tables", cache = TRUE, fig.height= 7, fig.width= 13, eval=FALSE}
mex <- read.csv("./mexico/polygons.csv")[, -1]

## Associating value with response
value <- (filter(state.wise, month == 1, 
       year == 2009, crime == "HOMICIDIOS") %.% 
         arrange(state_code))$total.rate

homicides.2009.1 <- mutate(mex, value = value[region])

value <- (filter(state.wise, month == 1, 
                 year == 2014, crime == "HOMICIDIOS") %.% 
            arrange(state_code))$total.rate
homicides.2014.1 <- mutate(mex, value = value[region])

homicides <- rbind(cbind(homicides.2014.1, date = "Jan 2014"),
                   cbind(homicides.2009.1, date = "Jan 2009")) 

ggplot(data = homicides, aes(x, y)) +
    geom_polygon(col = "darkred", aes(order = order, group = group, 
       fill = value)) +
    facet_wrap(~ date) +
  scale_fill_gradient(low='white', high='darkred')


ggplot(data = mex, aes(x, y)) + geom_polygon(col = "darkred", aes(order = order, group = group, fill = region == 10)) 

```

I will try now to do it in `ggvis`.
```{r , dependson= "maps", fig.height= 7, fig.width= 13, eval=FALSE}
suppressPackageStartupMessages(library("ggvis"))

ggvis(homicides.2014.1, props(x= ~x, y= ~y)) +
    layer_path(data= by_group(group))
```


This is use code is used when I was exploring the website to download the data.
```{r code, eval = FALSE}
###
### Part of the trials for downloading the data
###
# 
# library(XML) ## Loading library to read websites.
# 
# ## Main Page
# url <- "http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva"
# ## Crimes page
# url <- "http://www.incidenciadelictiva.secretariadoejecutivo.gob.mx/wdelito/"
# 
# ## Selecting periods page: Fuero Federal
# 
# ## This does not contain the information.
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/testpage.jsp"
# 
# ## Year, state and month
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/testpage.jsp?query=anio_ent_mes_ff"
# 
# 
# ## All crime types
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/"
# 
# ## Parsing the site
# doc <- htmlParse(url)
# 
# ## Obtaining root
# root <- xmlRoot(doc)
# 
# ## Some numbers to look at
# length(xmlChildren(root)) ## Two elements in the structure
# names(xmlChildren(root)) ## Names of the two elements
# length(xmlChildren(xmlChildren(root)[[2]]))
# 
# ## Selecting body children
# body <- xmlChildren(xmlChildren(root)[[2]])
# 
# names(body)
# 
# body
# 
# download.file("http://www.secretariadoejecutivo.gob.mx/work/models/SecretariadoEjecutivo/Resource/131/1/images/publicacionFebrero2014_032014.pdf", "mes.pdf")
# 
# getNodeSet(root, "//*")
```


Remaining work
-------------------------------------
1. For sake of illustration, I considered only number of homicides. A representative selection of crimes must be done.
2. Use `shiny` or `ggvis` to interactive plots in such way that the user can select the crime and the days of dates, respectively for the first and second plots of homicides.
3. Add the option of an smoothing method.
4. The last plots of homicides is the one that compares two different dates and the value is displayed as color intensity. I am going to make this interactive, so the user can select the month and year for each map and also select the crime.